<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Countdown — Bomb Viewer</title>
<style>
  :root{
    --bg: #0f1115;
    --fg: #e7e9ee;
    --muted: #8e95a3;
    --bomb: #1f2430;
    --bomb-hl: #2b3242;
    --fuse: #caa46a;
    --spark: #ffcc33;
    --danger: #ff3b3b;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial;
    display:flex; align-items:center; justify-content:center;
    padding:24px;
  }
  .wrap{ max-width: 900px; width:100%; display:grid; gap:16px; justify-items:center; text-align:center; }
  h1{ margin:0; font-size: clamp(18px, 2.2vw, 24px); font-weight:700; }
  .desc{ color: var(--muted); font-size: 14px; max-width: 640px; }
  .timer{ font-size: clamp(32px, 6vw, 56px); font-weight: 800; letter-spacing: 1px; }
  .meta{ color: var(--muted); font-size: 12px; }
  .stage{ width:min(90vw,560px); aspect-ratio: 1 / 1; position:relative; }
  svg{ width:100%; height:100%; display:block; }
  .spark{
    filter: drop-shadow(0 0 6px var(--spark)) drop-shadow(0 0 16px var(--spark));
    transform-origin: center;
    animation: flick 0.25s infinite alternate ease-in-out;
  }
  @keyframes flick { from{ opacity:.85; transform: scale(1);} to{ opacity:1; transform: scale(1.12);} }

  /* BOOM overlay */
  .boom{ position:absolute; inset:0; display:none; place-items:center; }
  .boom.active{ display:grid; animation: shake 0.35s ease-in-out 2; }
  .flash{
    position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(circle at center, rgba(255,255,255,.95), rgba(255,200,0,.85) 35%, rgba(255,0,0,.6) 60%, rgba(0,0,0,0) 70%);
    transform: scale(0); animation: explode 0.7s ease-out forwards;
  }
  .boomText{
    position:relative; z-index:2; font-size: clamp(28px, 7vw, 72px); font-weight: 900; color: var(--danger);
    text-shadow: 0 2px 0 #000, 0 0 24px rgba(255,59,59,.6);
    letter-spacing: 2px;
  }
  @keyframes explode { to { transform: scale(2.2); opacity:0; } }
  @keyframes shake {
    0%,100% { transform: translate(0,0); }
    20% { transform: translate(3px,-2px) rotate(-0.5deg); }
    40% { transform: translate(-3px,2px) rotate(0.5deg); }
    60% { transform: translate(2px,3px) rotate(0.3deg); }
    80% { transform: translate(-2px,-3px) rotate(-0.3deg); }
  }

  .hidden{ display:none !important; }
  .sr { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Loading…</h1>
  <div class="desc" id="text"></div>

  <div class="stage" aria-hidden="true">
    <!-- Escena SVG: bomba + mecha -->
    <svg viewBox="0 0 800 800" role="img" aria-label="Bomb with burning fuse">
      <!-- Bomba (cuerpo) -->
      <defs>
        <radialGradient id="bombGrad" cx="60%" cy="40%">
          <stop offset="0%" stop-color="var(--bomb-hl)"/>
          <stop offset="100%" stop-color="var(--bomb)"/>
        </radialGradient>
      </defs>

      <!-- Cuerpo de la bomba -->
      <circle id="bomb" cx="360" cy="520" r="180" fill="url(#bombGrad)" />
      <!-- Brillo -->
      <circle cx="430" cy="460" r="40" fill="rgba(255,255,255,0.08)" />
      <!-- Cuello / mecha base (justo sobre la "tapa" de la bomba) -->
      <rect x="350" y="330" width="20" height="40" rx="6" fill="#6b4f2d"/>

      <!-- Mecha: arranca en el cuello (370,330) y serpentea hacia arriba-derecha -->
      <!-- pathLength=1 nos permite trabajar con progreso [0..1] -->
      <path id="fusePath"
            d="M 360 330
               C 380 270, 470 260, 520 300
               C 600 360, 650 260, 700 320
               C 740 370, 640 420, 560 380
               C 500 350, 440 360, 420 340"
            fill="none"
            stroke="var(--fuse)" stroke-width="10" stroke-linecap="round"
            pathLength="1" />

      <!-- Chispa -->
      <g id="spark" class="spark">
        <circle r="10" fill="var(--spark)"></circle>
        <circle r="4" fill="#fff"></circle>
      </g>

      <!-- Humo suave (decorativo) -->
      <g opacity="0.08">
        <circle cx="520" cy="300" r="18" fill="#fff"/>
        <circle cx="540" cy="280" r="10" fill="#fff"/>
        <circle cx="560" cy="290" r="14" fill="#fff"/>
      </g>
    </svg>

    <!-- Overlay de explosión -->
    <div id="boom" class="boom">
      <div class="flash"></div>
      <div class="boomText">BOOM!</div>
    </div>
  </div>

  <div class="timer" id="timer">--:--:--</div>
  <div class="meta" id="status" aria-live="polite"></div>
  <div class="sr" id="sr-live" aria-live="assertive"></div>
</div>

<script>
/* Utilidades base64url */
function b64uDecode(b64){
  try{
    const s = atob(b64.replace(/-/g,'+').replace(/_/g,'/'));
    return JSON.parse(decodeURIComponent(escape(s)));
  }catch(e){ return null; }
}
function pad(n){ return String(n).padStart(2,'0'); }

(function(){
  const hash = location.hash.slice(1);
  if(!hash){
    document.getElementById('title').innerText = "No countdown data";
    document.getElementById('text').innerText = "Open a link generated by the editor.";
    document.querySelector('.stage').classList.add('hidden');
    return;
  }
  const data = b64uDecode(hash);
  if(!data){
    document.getElementById('title').innerText = "Invalid link";
    document.querySelector('.stage').classList.add('hidden');
    return;
  }

  document.getElementById('title').innerText = data.title || "Contest countdown";
  document.getElementById('text').innerText  = data.text  || "Solve the challenge before the fuse burns out!";

  // Determinar inicio (igual que antes)
  const key = 'count:'+hash;
  let firstOpen;
  if(data.mode === 'firstAccessClient'){
    const existing = localStorage.getItem(key);
    firstOpen = existing ? Number(existing) : Date.now();
    if(!existing) localStorage.setItem(key, String(firstOpen));
  } else if(data.mode === 'absolute'){
    firstOpen = data.createdAt || Date.now();
  } else {
    const existing = localStorage.getItem(key);
    firstOpen = existing ? Number(existing) : Date.now();
    if(!existing) localStorage.setItem(key, String(firstOpen));
  }

  const lifetime = Math.max(0, Number(data.lifetime_ms) || 0);
  const expiresAt = firstOpen + lifetime;

  // SVG refs
  const fuse  = document.getElementById('fusePath');
  const spark = document.getElementById('spark');
  const bomb  = document.getElementById('bomb');
  const boom  = document.getElementById('boom');

  // Mecha preparada para ser "recortada" desde el inicio (cuello de la bomba)
  // Con pathLength=1, dasharray=1 y dashoffset en [0..1] consumimos la mecha desde la bomba hacia fuera.
  fuse.style.strokeDasharray = 1;
  fuse.style.strokeDashoffset = 0;

  const totalLen = fuse.getTotalLength();

  const timerEl = document.getElementById('timer');
  const statusEl= document.getElementById('status');
  const liveEl  = document.getElementById('sr-live');

  let ended = false;
  function fmt(ms){
    const d = Math.floor(ms/86400000);
    const h = Math.floor(ms%86400000/3600000);
    const m = Math.floor(ms%3600000/60000);
    const s = Math.floor(ms%60000/1000);
    return (d>0? d+'d ':'') + `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  function tick(){
    const now = Date.now();
    const rem = Math.max(0, expiresAt - now);

    if(rem <= 0){
      if(!ended){
        ended = true;
        timerEl.textContent = "00:00:00";
        statusEl.textContent = "Time is up.";
        liveEl.textContent = "Countdown finished.";

        // BOOM
        bomb.style.opacity = 0;
        boom.classList.add('active');
        fuse.style.opacity = 0.1;
        spark.style.display = 'none';
      }
      return;
    }

    timerEl.textContent = fmt(rem);
    statusEl.textContent = `Expires at: ${new Date(expiresAt).toLocaleString()}`;

    // Progreso [0..1] desde el inicio (0) hasta el final (1)
    const progress = 1 - (rem / lifetime);
    const p = Math.min(1, Math.max(0, progress));

    // Consumimos la mecha desde la bomba hacia afuera
    fuse.style.strokeDashoffset = p;

    // Posición de la chispa: a lo largo del path según progreso real
    const pt = fuse.getPointAtLength(totalLen * p);
    spark.setAttribute('transform', `translate(${pt.x}, ${pt.y})`);

    requestAnimationFrame(tick);
  }

  // Coloca la chispa al inicio exacto (cuello) antes del primer frame
  const startPt = fuse.getPointAtLength(0);
  spark.setAttribute('transform', `translate(${startPt.x}, ${startPt.y})`);

  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
